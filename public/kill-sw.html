<!doctype html>
<html lang="ja">
<meta charset="utf-8" />
<title>NoirChord: kill old Service Workers</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  body{font-family:system-ui,Segoe UI,Helvetica,Arial,sans-serif;background:#111;color:#eee;padding:24px}
  .card{max-width:780px;margin:auto;border:1px solid #333;border-radius:12px;padding:20px;background:#151515}
  h1{font-size:1.3rem;margin:0 0 8px}
  button{padding:10px 16px;border-radius:8px;border:1px solid #444;background:#222;color:#eee;cursor:pointer}
  pre{white-space:pre-wrap;background:#0f0f0f;border:1px solid #333;border-radius:8px;padding:12px}
</style>
<div class="card">
  <h1>Kill old Service Workers</h1>
  <p>旧バージョンの Service Worker とキャッシュを削除します。実行後、ページを再読み込みしてください。</p>
  <button id="run">Unregister & Clear Caches</button>
  <p id="out"></p>
  <pre id="log"></pre>
</div>
<script>
const out = document.getElementById('out');
const log = document.getElementById('log');
function w(s){ log.textContent += s + '\n'; }
async function kill() {
  try {
    w('Start: unregister service workers...');
    if ('serviceWorker' in navigator) {
      const regs = await navigator.serviceWorker.getRegistrations();
      if (regs.length === 0) w('- No registrations');
      for (const r of regs) {
        w('- unregister: ' + (r.scope || '(no scope)'));
        await r.unregister();
      }
    } else {
      w('serviceWorker is not supported.');
    }
    w('Clear caches...');
    if (window.caches && caches.keys) {
      const keys = await caches.keys();
      for (const k of keys) {
        w('- delete cache: ' + k);
        await caches.delete(k);
      }
    }
    out.textContent = 'Done. Please hard-reload (Ctrl+F5).';
  } catch (e) {
    out.textContent = 'Error: ' + e;
    w(String(e && e.stack || e));
  }
}
document.getElementById('run').addEventListener('click', kill);
</script>
</html>
